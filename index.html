<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA // ANRATH</title>
    <style>
        :root {
            --bg-color: #080808;
            --text-color: #e0e0e0;
            --accent-color: #888;
            --highlight-color: #fff;
            --border-width: 2px;
            /* 4x4 dither pattern */
            --dither-pattern: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAACVJREFUGFdjZEACDAwM/xkYGH4zMDAwMqACJmQOMN6fP39mYAAAFuEHCTp929sAAAAASUVORK5CYII=');
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Courier New", Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Dither Background Layer */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--dither-pattern);
            background-repeat: repeat;
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        .container {
            width: 90%;
            max-width: 700px;
            background: #121212;
            border: var(--border-width) solid var(--text-color);
            position: relative;
            z-index: 5;
            box-shadow: 12px 12px 0px rgba(255, 255, 255, 0.05);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        /* Corner accents */
        .container::after {
            content: "";
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: none;
        }

        header {
            border-bottom: var(--border-width) solid var(--text-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .logo-area h1 {
            font-size: 2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 4px;
            line-height: 1;
        }

        .logo-area .sub {
            font-size: 0.7rem;
            letter-spacing: 1px;
            color: var(--accent-color);
            margin-top: 5px;
        }

        .meta-info {
            text-align: right;
            font-size: 0.7rem;
            line-height: 1.4;
            color: var(--accent-color);
        }

        #file-list-header {
            display: grid;
            grid-template-columns: 1fr 100px 80px;
            padding: 0 10px 10px 10px;
            border-bottom: 1px solid #333;
            font-size: 0.7rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #file-list {
            list-style: none;
            max-height: 50vh;
            overflow-y: auto;
            margin-top: 5px;
        }

        #file-list::-webkit-scrollbar {
            width: 6px;
        }

        #file-list::-webkit-scrollbar-track {
            background: #000;
        }

        #file-list::-webkit-scrollbar-thumb {
            background: #444;
        }

        #file-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-color);
        }

        .file-item {
            display: grid;
            grid-template-columns: 1fr 100px 80px;
            padding: 12px 10px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: background 0.1s;
            align-items: center;
        }
        
        .file-item.directory {
            background-color: #232323;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }     

        .file-name {
            font-weight: bold;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-type {
            font-size: 0.75rem;
            text-align: center;
            font-family: monospace;
            opacity: 0.6;
        }

        .file-action {
            font-size: 0.7rem;
            text-align: right;
            text-decoration: underline;
            opacity: 0;
        }

        .file-item:hover .file-action {
            opacity: 1;
        }

        footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 0.65rem;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-tag {
            background: #222;
            color: #0f0;
            padding: 2px 6px;
            font-size: 0.6rem;
        }

        /* Visual Effects */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            background-size: 100% 4px;
            z-index: 100;
            pointer-events: none;
        }

        .noise {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--dither-pattern);
            opacity: 0.05;
            z-index: 101;
            pointer-events: none;
        }

        /* Toast notification */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--text-color);
            color: var(--bg-color);
            padding: 10px 20px;
            font-size: 0.8rem;
            border: 2px solid var(--bg-color);
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="noise"></div>
    <div id="toast">URL copied to clipboard</div>

    <div class="container">
        <header>
            <div class="logo-area">
                <h1>DATA</h1>
                <div class="sub">FILE REPOSITORY // STATIC_HOST</div>
            </div>
            <div class="meta-info">
                <div>HOST: anrath.github.io</div>
                <div id="current-date">DATE: --/--/----</div>
                <div id="file-count">FILES: --</div>
            </div>
        </header>
        
        <div id="file-list-header">
            <span>Name</span>
            <span style="text-align: center;">Format</span>
            <span style="text-align: right;">Action</span>
        </div>
        <div id="file-list">
            <div class="file-item">
                <span class="file-name">Initializing...</span>
            </div>
        </div>

        <footer>
            <div>
                <span id="path-display">[ROOT]:/files/</span> <br>
                CURL_SUPPORT: ENABLED
            </div>
            <div>
                <span class="status-tag">SYSTEM_ONLINE</span>
            </div>
        </footer>
    </div>

    <script>
        // Set current date
        const now = new Date();
        document.getElementById('current-date').textContent = `DATE: ${now.toLocaleDateString()}`;

        let allFiles = [];
        let currentPath = []; // Array of directory names

        async function loadFiles() {
            try {
                const response = await fetch('files.json');
                allFiles = await response.json();
                renderCurrentPath();
            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('file-list').innerHTML = `
                    <div class="file-item">
                        <span class="file-name" style="color: #f00;">Error: Failed to fetch manifest</span>
                    </div>`;
            }
        }

        // ============================================
        // Constants
        // ============================================
        const TOAST_DURATION_MS = 2000;
        const SAFE_PATH_PATTERN = /^[a-zA-Z0-9_\-./]+$/;

        // ============================================
        // Utility Functions
        // ============================================

        /**
         * Displays a toast notification message.
         * @param {string} message - Message to display
         */
        function showToast(message) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, TOAST_DURATION_MS);
        }

        /**
         * Validates a file path to ensure it's safe for use in URLs and shell commands.
         * Prevents path traversal and shell injection.
         * @param {string} filePath - Path to validate
         * @returns {boolean} True if path is safe
         */
        function isValidPath(filePath) {
            if (typeof filePath !== 'string' || filePath.length === 0) return false;
            if (filePath.includes('..')) return false;
            if (!SAFE_PATH_PATTERN.test(filePath)) return false;
            return true;
        }

        /**
         * Escapes special characters for safe use in shell grep patterns.
         * @param {string} str - String to escape
         * @returns {string} Escaped string
         */
        function escapeForGrep(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        /**
         * Constructs the base URL for file operations.
         * @returns {string} Base URL ending with /
         */
        function getBaseUrl() {
            return window.location.href.split(/[?#]/)[0].replace(/\/?$/, '/');
        }

        // ============================================
        // Clipboard Operations
        // ============================================

        /**
         * Copies text to clipboard with user feedback.
         * @param {string} text - Text to copy
         * @param {boolean} isUrl - Whether to resolve as URL first
         */
        async function copyToClipboard(text, isUrl = false) {
            try {
                const content = isUrl ? new URL(text, window.location.href).href : text;
                await navigator.clipboard.writeText(content);
                showToast(isUrl ? 'URL copied to clipboard' : 'Command copied to clipboard');
            } catch (err) {
                console.error('Clipboard operation failed:', err);
                showToast('Failed to copy to clipboard');
            }
        }

        /**
         * Generates and copies a curl command for downloading a directory.
         * @param {string} dirPath - Directory path to download
         */
        function copyCurlCommand(dirPath) {
            if (!isValidPath(dirPath)) {
                showToast('Invalid directory path');
                console.error('Invalid path rejected:', dirPath);
                return;
            }

            const baseUrl = getBaseUrl();
            // Strip "files/" prefix to match files.txt format
            const cleanPath = dirPath.replace(/^files\//, '');
            const escapedPath = escapeForGrep(cleanPath);
            const cmd = `curl -s "${baseUrl}files.txt" | grep "^${escapedPath}/" | while read -r line; do curl --create-dirs -o "$line" "${baseUrl}files/$line"; done`;
            copyToClipboard(cmd, false);
        }

        // ============================================
        // Navigation Functions
        // ============================================

        /**
         * Retrieves the file list for the current navigation path.
         * @returns {Array} Files and directories at current path
         */
        function getCurrentFolder() {
            let current = allFiles;
            for (const segment of currentPath) {
                const found = current.find(item => item.type === 'directory' && item.name === segment);
                if (found && found.children) {
                    current = found.children;
                } else {
                    return [];
                }
            }
            return current;
        }

        // ============================================
        // UI Rendering Functions
        // ============================================

        /**
         * Sorts files with directories first, then alphabetically.
         * @param {Array} files - Array of file/directory objects
         * @returns {Array} Sorted array
         */
        function sortFilesDirectoriesFirst(files) {
            return [...files].sort((a, b) => {
                if (a.type === 'directory' && b.type !== 'directory') return -1;
                if (a.type !== 'directory' && b.type === 'directory') return 1;
                return a.name.localeCompare(b.name);
            });
        }

        /**
         * Creates the "go back" navigation element.
         * @returns {HTMLElement} Back navigation element
         */
        function createBackNavigationElement() {
            const backItem = document.createElement('div');
            backItem.className = 'file-item';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-name';
            nameSpan.textContent = '.. [BACK]';

            const typeSpan = document.createElement('span');
            typeSpan.className = 'file-type';
            typeSpan.textContent = 'DIR';

            const actionSpan = document.createElement('span');
            actionSpan.className = 'file-action';
            actionSpan.textContent = 'GO UP';

            backItem.appendChild(nameSpan);
            backItem.appendChild(typeSpan);
            backItem.appendChild(actionSpan);

            backItem.addEventListener('click', () => {
                currentPath.pop();
                renderCurrentPath();
            });

            return backItem;
        }

        /**
         * Creates action buttons for a directory item.
         * @param {Object} item - Directory item object
         * @returns {HTMLElement} Action span with buttons
         */
        function createDirectoryActions(item) {
            const actionSpan = document.createElement('span');
            actionSpan.className = 'file-action';

            const openBtn = document.createElement('span');
            openBtn.textContent = 'OPEN';
            openBtn.style.cursor = 'pointer';
            openBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentPath.push(item.name);
                renderCurrentPath();
            });

            const sep = document.createTextNode(' | ');

            const curlBtn = document.createElement('span');
            curlBtn.textContent = 'CURL';
            curlBtn.style.cursor = 'pointer';
            curlBtn.title = 'Copy curl command to download this directory';
            curlBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyCurlCommand(item.path);
            });

            actionSpan.appendChild(openBtn);
            actionSpan.appendChild(sep);
            actionSpan.appendChild(curlBtn);

            return actionSpan;
        }

        /**
         * Creates a list item element for a file or directory.
         * @param {Object} item - File or directory object
         * @returns {HTMLElement} List item element
         */
        function createFileListItem(item) {
            const element = document.createElement('div');
            element.className = `file-item ${item.type}`;

            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-name';
            nameSpan.textContent = item.type === 'directory' ? `${item.name}/` : item.name;

            const typeSpan = document.createElement('span');
            typeSpan.className = 'file-type';
            typeSpan.textContent = item.type === 'directory' 
                ? 'DIR' 
                : item.name.split('.').pop().toUpperCase();

            const actionSpan = item.type === 'directory'
                ? createDirectoryActions(item)
                : (() => {
                    const span = document.createElement('span');
                    span.className = 'file-action';
                    span.textContent = 'OPEN & COPY';
                    return span;
                })();

            element.appendChild(nameSpan);
            element.appendChild(typeSpan);
            element.appendChild(actionSpan);

            element.addEventListener('click', () => {
                if (item.type === 'directory') {
                    currentPath.push(item.name);
                    renderCurrentPath();
                } else if (isValidPath(item.path)) {
                    copyToClipboard(item.path, true);
                    window.open(item.path, '_blank');
                }
            });

            return element;
        }

        /**
         * Creates an empty state message element.
         * @param {string} message - Message to display
         * @returns {HTMLElement} Empty state element
         */
        function createEmptyStateElement(message) {
            const element = document.createElement('div');
            element.className = 'file-item';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'file-name';
            nameSpan.textContent = message;
            element.appendChild(nameSpan);
            return element;
        }

        /**
         * Updates the path display in the footer.
         */
        function updatePathDisplay() {
            const pathDisplay = document.getElementById('path-display');
            if (pathDisplay) {
                const pathStr = currentPath.join('/');
                pathDisplay.textContent = `[ROOT]:/files/${pathStr}${currentPath.length > 0 ? '/' : ''}`;
            }
        }

        /**
         * Updates the file/directory count display.
         * @param {Array} files - Current file list
         */
        function updateFileCount(files) {
            const countElement = document.getElementById('file-count');
            if (countElement) {
                const fileCount = files.filter(f => f.type === 'file').length;
                const dirCount = files.filter(f => f.type === 'directory').length;
                countElement.textContent = `FILES: ${fileCount} / DIRS: ${dirCount}`;
            }
        }

        /**
         * Renders the current directory listing.
         */
        function renderCurrentPath() {
            const files = sortFilesDirectoriesFirst(getCurrentFolder());
            const listElement = document.getElementById('file-list');
            
            if (!listElement) return;
            listElement.innerHTML = '';

            updatePathDisplay();
            updateFileCount(files);

            // Add back navigation if not at root
            if (currentPath.length > 0) {
                listElement.appendChild(createBackNavigationElement());
            }

            // Handle empty state
            if (files.length === 0 && currentPath.length === 0) {
                listElement.appendChild(createEmptyStateElement('No files found.'));
                return;
            }

            // Render file items
            files.forEach(item => {
                listElement.appendChild(createFileListItem(item));
            });
        }

        loadFiles();
    </script>
</body>
</html>
